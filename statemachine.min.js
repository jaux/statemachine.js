(function(p){var I=p.StateMachine,b=p.StateMachine={__version__:"0.1.0",__license__:"MIT",__author__:"Ye Liu",__contact__:"yeliu@instast.com",__copyright__:"Copyright (c) 2013 Ye Liu"};b.noConflict=function(){p.StateMachine=I;return this};b.init=function(b,g,h,a){var c;switch(arguments.length){case 0:b={};g=[];break;case 1:b=b||{};case 2:g=f(g||b.states)}c=v(b,g);c.callEntryIfTransitBack=r(h)?h:!0;c.callExitIfTransitBack=r(a)?a:!0;b.fsm=c;b.handleStateTrigger=w(c);b.getCurrentStateName=function(){return c.currentState?
c.currentState.name:null};b.getPreviousStateName=function(){return c.previousState?c.previousState.name:null};0<g.length&&(c.currentState=s(c,g[0].name),t(c));return b};var v=function(b,g){var h={host:b,statesMap:{},currentState:null,currentStateStack:[]};g=f(g);for(var a=0,c=g.length;a<c;a++)x(h.statesMap,g[a]);return h},x=function g(b,a,c){m(a)?a={name:a}:a||(a={});m(a.name)||(a.name="UnnamedState");var d={name:a.name,fqn:a.name,entry:a.entry,exit:a.exit,transitions:[],outerState:null,innerStates:[]};
c&&(d.fqn=c.fqn+"."+d.name,d.outerState=c);b[d.fqn]=d;a.transitions=f(a.transitions);for(var e=0,l=a.transitions.length;e<l;e++)c=a.transitions[e],d.transitions[e]={trigger:c.trigger,dest:c.dest,action:c.action,guard:c.guard};a.innerStates=f(a.innerStates);e=0;for(l=a.innerStates.length;e<l;e++)d.innerStates[e]=g(b,a.innerStates[e],d);return d},w=function(b){var h=b.host;return function(a,c,d){var e=b.currentState;a=y(e,a);for(var l,f,k=0,m=a.length;k<m;k++)if(l=a[k],!1!==n(l.guard,h,d)&&(f=s(b,l.dest))){n(l.action,
h,c);(f!==e&&f.outerState!==e||f===e&&b.callExitIfTransitBack)&&z(b,e,f);(function J(a,c){A(b,a,c);(c!==a||b.callEntryIfTransitBack)&&t(b);0<c.innerStates.length&&J(c,c.innerStates[0])})(e,f);break}}},y=function(b,h){var a=[],c;if(b)for(var d=0,e=b.transitions.length;d<e;d++)c=b.transitions[d],c.trigger===h&&a.push(c);return a},s=function h(a,b){var d,e=a.currentState?a.currentState.outerState:null;e?(d=a.statesMap[e.fqn+"."+b],d||(B(a,e),d=h(a,b),C(a))):d=a.statesMap[b];return d},B=function(b,a){b.currentStateStack.push(b.currentState);
b.currentState=a},C=function(b){b.currentState=b.currentStateStack.pop()},A=function(b,a,c){b.previousState=a;b.currentState=c},t=function(b){var a=b.host;if(b=b.currentState)n(b.entry,a),a.handleStateTrigger(".")},z=function a(b,d,e){var f=d.outerState;n(d.exit,b.host);f&&(f!==e&&f!==e.outerState)&&a(b,d.outerState,e)},u=function(a){return void 0!==a&&null!==a&&"[object Object]"===k.call(a)},q=function(a){return"[object Function]"===k.call(a)},m=function(a){return"[object String]"===k.call(a)},D=
function(a){return"[object Number]"===k.call(a)},r=function(a){return"[object Boolean]"===k.call(a)},E=Array.isArray||function(a){return"[object Array]"===k.call(a)},F=function(a){return D(a.length)&&!u(a)&&!m(a)&&!q(a)},f=function(a){return void 0===a||null===a?[]:E(a)?a:F(a)?Array.prototype.slice.call(a,0):[a]},H=function(a,b){return q(a)?a:m(a)&&u(b)&&q(b[a])?b[a]:G},n=function(a,b,d){return H(a,b).apply(b,f(d))},k=Object.prototype.toString,G=function(){};p.STATEMACHINE_EXPORT_EXTRA&&(b.isObject=
u,b.isFunction=q,b.isString=m,b.isNumber=D,b.isBoolean=r,b.isArray=E,b.isArrayLike=F,b.arrayFrom=f,b.functionFrom=H,b.functionApply=n,b.nop=G,b.initFsm=v,b.initState=x,b.handleStateTriggerFactory=w,b.getTransitions=y,b.getState=s,b.pushCurrentState=B,b.popCurrentState=C,b.changeState=A,b.doEntryAction=t,b.doExitAction=z)})(this);
